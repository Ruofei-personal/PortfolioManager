<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Manager</title>
    <meta
      name="description"
      content="Portfolio Manager helps you track holdings, visualize allocation, and manage investments with ease."
    />
    <meta name="theme-color" content="#0b0f1a" />
    <meta property="og:title" content="Portfolio Manager" />
    <meta
      property="og:description"
      content="Track holdings, visualize allocation, and manage investments with ease."
    />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:site_name" content="Portfolio Manager" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Portfolio Manager" />
    <meta
      name="twitter:description"
      content="Track holdings, visualize allocation, and manage investments with ease."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  </head>
  <body>
    <div class="ambient"></div>
    <div class="app-shell" id="app">
      <header class="topbar">
        <div class="brand">
          <span class="brand-icon">◆</span>
          <div>
            <p class="brand-title">{{ t("brandTitle") }}</p>
            <p class="brand-subtitle">{{ t("brandSubtitle") }}</p>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="ghost-btn" type="button" @click="toggleLocale">
            {{ localeLabel }}
          </button>
          <button class="ghost-btn" type="button" @click="logout" v-if="isAuthed">
            {{ t("logout") }}
          </button>
        </div>
      </header>
      <div
        class="notice"
        v-if="notice.message"
        :class="notice.type"
        role="status"
        aria-live="polite"
      >
        {{ notice.message }}
      </div>

      <main>
        <section class="auth" v-if="!isAuthed">
          <div class="auth-card">
            <h1>{{ t("welcomeBack") }}</h1>
            <p>{{ t("welcomeSubtitle") }}</p>
            <form @submit.prevent="login">
              <label>
                {{ t("email") }}
                <input
                  v-model="loginForm.email"
                  type="email"
                  :placeholder="t('emailPlaceholder')"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                {{ t("password") }}
                <input
                  v-model="loginForm.password"
                  type="password"
                  :placeholder="t('passwordPlaceholder')"
                  autocomplete="current-password"
                  required
                />
              </label>
              <button type="submit" class="primary-btn" :disabled="isLoading.login">
                {{ isLoading.login ? t("loading") : t("login") }}
              </button>
            </form>
            <div class="divider">{{ t("or") }}</div>
            <form @submit.prevent="register">
              <label>
                {{ t("email") }}
                <input
                  v-model="registerForm.email"
                  type="email"
                  :placeholder="t('emailPlaceholder')"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                {{ t("password") }}
                <input
                  v-model="registerForm.password"
                  type="password"
                  :placeholder="t('passwordMinPlaceholder')"
                  autocomplete="new-password"
                  minlength="6"
                  required
                />
              </label>
              <button type="submit" class="secondary-btn" :disabled="isLoading.register">
                {{ isLoading.register ? t("loading") : t("createAccount") }}
              </button>
            </form>
            <p class="hint">{{ t("dataHint") }}</p>
          </div>
          <div class="auth-visual">
            <div class="glass-card">
              <h2>{{ t("visualTitle") }}</h2>
              <p>{{ t("visualSubtitle") }}</p>
              <ul>
                <li>{{ t("visualFeatureOne") }}</li>
                <li>{{ t("visualFeatureTwo") }}</li>
                <li>{{ t("visualFeatureThree") }}</li>
              </ul>
            </div>
          </div>
        </section>

        <section class="dashboard" v-else>
          <div class="dashboard-grid">
            <div class="panel">
              <div class="panel-header panel-header-row">
                <div>
                  <h2>{{ t("overviewTitle") }}</h2>
                  <p>{{ t("greeting", { email: userEmail }) }}</p>
                </div>
                <div class="panel-actions">
                  <label class="select-inline">
                    <span>{{ t("chartMetric") }}</span>
                    <select v-model="chartMetric">
                      <option value="cost">{{ t("chartMetricCost") }}</option>
                      <option value="market">{{ t("chartMetricMarket") }}</option>
                    </select>
                  </label>
                </div>
              </div>
              <div class="chart-wrapper">
                <canvas id="portfolioChart" height="280"></canvas>
              </div>
              <div class="stats">
                <div>
                  <span>{{ t("statAssets") }}</span>
                  <strong>{{ stats.assetCount }}</strong>
                </div>
                <div>
                  <span>{{ t("statTotalCost") }}</span>
                  <strong>{{ stats.totalCost }}</strong>
                </div>
                <div>
                  <span>{{ t("statMarketValue") }}</span>
                  <strong>{{ stats.marketValue }}</strong>
                </div>
                <div>
                  <span>{{ t("statAverageCost") }}</span>
                  <strong>{{ stats.averageCost }}</strong>
                </div>
                <div>
                  <span>{{ t("statUnrealized") }}</span>
                  <strong :class="stats.unrealizedClass">{{ stats.unrealizedGain }}</strong>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <h2>{{ t("formTitle") }}</h2>
                <p>{{ t("formSubtitle") }}</p>
              </div>
              <form class="asset-form" @submit.prevent="saveAsset">
                <label>
                  {{ t("assetName") }}
                  <input
                    v-model="assetForm.name"
                    type="text"
                    :placeholder="t('assetNamePlaceholder')"
                    @input="clearAssetError('name')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.name">{{ assetErrors.name }}</span>
                </label>
                <label>
                  {{ t("category") }}
                  <select v-model="assetForm.category" required>
                    <option v-for="option in categories" :key="option.value" :value="option.value">
                      {{ t(option.labelKey) }}
                    </option>
                  </select>
                </label>
                <label>
                  {{ t("quantity") }}
                  <input
                    v-model.number="assetForm.quantity"
                    type="number"
                    min="1"
                    step="1"
                    @input="clearAssetError('quantity')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.quantity">{{ assetErrors.quantity }}</span>
                </label>
                <label>
                  {{ t("totalCost", { currency: currencySymbol }) }}
                  <input
                    v-model.number="assetForm.cost"
                    type="number"
                    min="0"
                    step="0.01"
                    @input="clearAssetError('cost')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.cost">{{ assetErrors.cost }}</span>
                </label>
                <label>
                  {{ t("currentPrice", { currency: currencySymbol }) }}
                  <input
                    v-model.number="assetForm.currentPrice"
                    type="number"
                    min="0"
                    step="0.01"
                    @input="clearAssetError('currentPrice')"
                  />
                  <span class="field-error" v-if="assetErrors.currentPrice">
                    {{ assetErrors.currentPrice }}
                  </span>
                </label>
                <div class="form-split">
                  <label>
                    {{ t("currency") }}
                    <select v-model="assetForm.currency">
                      <option v-for="option in currencies" :key="option" :value="option">
                        {{ option }}
                      </option>
                    </select>
                  </label>
                  <label>
                    {{ t("tags") }}
                    <input
                      v-model="assetForm.tags"
                      type="text"
                      :placeholder="t('tagsPlaceholder')"
                    />
                  </label>
                </div>
                <label>
                  {{ t("assetNote") }}
                  <textarea
                    v-model="assetForm.note"
                    :placeholder="t('assetNotePlaceholder')"
                    rows="3"
                  ></textarea>
                </label>
                <div class="form-actions">
                  <button type="submit" class="primary-btn" :disabled="isLoading.save">
                    {{ isLoading.save ? t("saving") : editingLabel }}
                  </button>
                  <button
                    v-if="isEditing"
                    type="button"
                    class="secondary-btn"
                    @click="cancelEdit"
                    :disabled="isLoading.save"
                  >
                    {{ t("cancelEdit") }}
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="panel table-panel" aria-live="polite">
            <div class="panel-header">
              <h2>{{ t("tableTitle") }}</h2>
              <p>{{ t("tableSubtitle") }}</p>
            </div>
            <div class="table-actions">
              <div class="table-filters">
                <label class="filter-field">
                  <span class="filter-label">{{ t("searchPlaceholder") }}</span>
                  <input v-model.trim="filters.query" type="search" :placeholder="t('searchPlaceholder')" />
                </label>
                <label class="filter-field">
                  <span class="filter-label">{{ t("category") }}</span>
                  <select v-model="filters.category">
                    <option value="all">{{ t("filterAll") }}</option>
                    <option v-for="option in categories" :key="option.value" :value="option.value">
                      {{ t(option.labelKey) }}
                    </option>
                  </select>
                </label>
                <label class="filter-field">
                  <span class="filter-label">{{ t("filterSort") }}</span>
                  <select v-model="filters.sort">
                    <option value="recent">{{ t("sortRecent") }}</option>
                    <option value="name">{{ t("sortName") }}</option>
                    <option value="totalCost">{{ t("sortTotalCost") }}</option>
                    <option value="quantity">{{ t("sortQuantity") }}</option>
                  </select>
                </label>
              </div>
              <div class="table-action-buttons">
                <button class="ghost-btn" type="button" @click="applyQuickSort('totalCost')">
                  {{ t("quickSortTotal") }}
                </button>
                <button class="ghost-btn" type="button" @click="applyQuickSort('quantity')">
                  {{ t("quickSortQuantity") }}
                </button>
                <button class="ghost-btn" type="button" @click="clearFilters" :disabled="!hasActiveFilters">
                  {{ t("clearFilters") }}
                </button>
                <label class="ghost-btn file-btn">
                  {{ t("importCsv") }}
                  <input type="file" accept=".csv" @change="importCsv" />
                </label>
                <button class="ghost-btn" type="button" @click="exportCsv" :disabled="!portfolio.length">
                  {{ t("exportCsv") }}
                </button>
              </div>
            </div>
            <table class="table" v-if="visiblePortfolio.length" aria-label="Holdings">
              <thead>
                <tr>
                  <th scope="col">{{ t("assetName") }}</th>
                  <th scope="col">{{ t("quantity") }}</th>
                  <th scope="col">{{ t("statTotalCost") }}</th>
                  <th scope="col">{{ t("statMarketValue") }}</th>
                  <th scope="col">{{ t("statUnrealized") }}</th>
                  <th scope="col">{{ t("costPerShare") }}</th>
                  <th scope="col">{{ t("category") }}</th>
                  <th scope="col">{{ t("actions") }}</th>
                </tr>
              </thead>
              <tbody>
                <tr class="asset-row" v-for="asset in visiblePortfolio" :key="asset.id">
                  <td>
                    <div class="asset-name">{{ asset.name }}</div>
                    <div class="asset-tags">
                      <span class="badge">{{ t("category") }} {{ categoryLabel(asset.category) }}</span>
                      <span class="badge badge-muted">
                        {{ t("avgCostLabel", { value: currency(asset.totalCost / asset.quantity, asset.currency) }) }}
                      </span>
                    </div>
                    <div class="asset-note" v-if="asset.note">{{ asset.note }}</div>
                    <div class="asset-tags-list" v-if="asset.tags">
                      <span v-for="tag in splitTags(asset.tags)" :key="tag" class="tag-pill">{{ tag }}</span>
                    </div>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("quantity") }}</span>
                    <span class="cell-value">{{ asset.quantity }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("statTotalCost") }}</span>
                    <span class="cell-value">{{ currency(asset.totalCost, asset.currency) }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("statMarketValue") }}</span>
                    <span class="cell-value">{{ currency(marketValue(asset), asset.currency) }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("statUnrealized") }}</span>
                    <span class="cell-value" :class="gainClass(asset)">
                      {{ currency(unrealizedGain(asset), asset.currency) }}
                    </span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("costPerShare") }}</span>
                    <span class="cell-value">
                      {{ currency(asset.totalCost / asset.quantity, asset.currency) }}
                    </span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("category") }}</span>
                    <span class="cell-value">{{ categoryLabel(asset.category) }}</span>
                  </td>
                  <td>
                    <div class="table-actions-cell">
                      <button class="ghost-btn" type="button" @click="startEdit(asset)">
                        {{ t("edit") }}
                      </button>
                      <button
                        class="delete-btn"
                        @click="deleteAsset(asset.id)"
                        :disabled="isLoading.deletingId === asset.id"
                      >
                        {{ isLoading.deletingId === asset.id ? t("deleting") : t("delete") }}
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="empty-state" v-else role="status">
              {{ hasActiveFilters ? t("emptyStateFiltered") : t("emptyState") }}
            </div>
          </div>

          <div class="panel">
            <div class="panel-header">
              <h2>{{ t("transactionsTitle") }}</h2>
              <p>{{ t("transactionsSubtitle") }}</p>
            </div>
            <div class="transactions" v-if="transactions.length">
              <div class="transaction" v-for="tx in transactions" :key="tx.id">
                <div>
                  <strong>{{ tx.holdingName }}</strong>
                  <span class="transaction-meta">
                    {{ t("transactionAction", { action: t(tx.action) }) }} ·
                    {{ categoryLabel(tx.category) }}
                  </span>
                </div>
                <div class="transaction-values">
                  <span>{{ tx.quantity }}</span>
                  <span>{{ currency(tx.totalCost) }}</span>
                  <span>{{ formatDate(tx.createdAt) }}</span>
                </div>
              </div>
            </div>
            <div class="empty-state" v-else>
              {{ t("transactionsEmpty") }}
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="/static/app.js" defer></script>
  </body>
</html>
