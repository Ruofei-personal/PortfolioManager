<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Manager</title>
    <meta
      name="description"
      content="Portfolio Manager helps you track holdings, visualize allocation, and manage investments with ease."
    />
    <meta name="theme-color" content="#0b0f1a" />
    <meta property="og:title" content="Portfolio Manager" />
    <meta
      property="og:description"
      content="Track holdings, visualize allocation, and manage investments with ease."
    />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:site_name" content="Portfolio Manager" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Portfolio Manager" />
    <meta
      name="twitter:description"
      content="Track holdings, visualize allocation, and manage investments with ease."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="/static/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  </head>
  <body>
    <div class="ambient"></div>
    <div class="app-shell" id="app">
      <header class="topbar">
        <div class="brand">
          <span class="brand-icon">◆</span>
          <div>
            <p class="brand-title">{{ t("brandTitle") }}</p>
            <p class="brand-subtitle">{{ t("brandSubtitle") }}</p>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="ghost-btn" type="button" @click="toggleLocale">
            {{ localeLabel }}
          </button>
          <button class="ghost-btn" type="button" @click="logout" v-if="isAuthed">
            {{ t("logout") }}
          </button>
        </div>
      </header>
      <div
        class="notice"
        v-if="notice.message"
        :class="notice.type"
        role="status"
        aria-live="polite"
      >
        {{ notice.message }}
      </div>

      <main>
        <section class="auth" v-if="!isAuthed">
          <div class="auth-card">
            <h1>{{ t("welcomeBack") }}</h1>
            <p>{{ t("welcomeSubtitle") }}</p>
            <form @submit.prevent="login">
              <label>
                {{ t("email") }}
                <input
                  v-model="loginForm.email"
                  type="email"
                  :placeholder="t('emailPlaceholder')"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                {{ t("password") }}
                <input
                  v-model="loginForm.password"
                  type="password"
                  :placeholder="t('passwordPlaceholder')"
                  autocomplete="current-password"
                  required
                />
              </label>
              <button type="submit" class="primary-btn" :disabled="isLoading.login">
                {{ isLoading.login ? t("loading") : t("login") }}
              </button>
            </form>
            <div class="divider">{{ t("or") }}</div>
            <form @submit.prevent="register">
              <label>
                {{ t("email") }}
                <input
                  v-model="registerForm.email"
                  type="email"
                  :placeholder="t('emailPlaceholder')"
                  autocomplete="email"
                  required
                />
              </label>
              <label>
                {{ t("password") }}
                <input
                  v-model="registerForm.password"
                  type="password"
                  :placeholder="t('passwordMinPlaceholder')"
                  autocomplete="new-password"
                  minlength="6"
                  required
                />
              </label>
              <button type="submit" class="secondary-btn" :disabled="isLoading.register">
                {{ isLoading.register ? t("loading") : t("createAccount") }}
              </button>
            </form>
            <p class="hint">{{ t("dataHint") }}</p>
          </div>
          <div class="auth-visual">
            <div class="glass-card">
              <h2>{{ t("visualTitle") }}</h2>
              <p>{{ t("visualSubtitle") }}</p>
              <ul>
                <li>{{ t("visualFeatureOne") }}</li>
                <li>{{ t("visualFeatureTwo") }}</li>
                <li>{{ t("visualFeatureThree") }}</li>
              </ul>
            </div>
          </div>
        </section>

        <section class="dashboard" v-else>
          <div class="dashboard-grid">
            <div class="panel">
              <div class="panel-header">
                <h2>{{ t("overviewTitle") }}</h2>
                <p>{{ t("greeting", { email: userEmail }) }}</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="portfolioChart" height="280"></canvas>
              </div>
              <div class="stats">
                <div>
                  <span>{{ t("statAssets") }}</span>
                  <strong>{{ stats.assetCount }}</strong>
                </div>
                <div>
                  <span>{{ t("statTotalCost") }}</span>
                  <strong>{{ stats.totalCost }}</strong>
                </div>
                <div>
                  <span>{{ t("statAverageCost") }}</span>
                  <strong>{{ stats.averageCost }}</strong>
                </div>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <h2>{{ t("formTitle") }}</h2>
                <p>{{ t("formSubtitle") }}</p>
              </div>
              <form class="asset-form" @submit.prevent="saveAsset">
                <label>
                  {{ t("assetName") }}
                  <input
                    v-model="assetForm.name"
                    type="text"
                    :placeholder="t('assetNamePlaceholder')"
                    @input="clearAssetError('name')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.name">{{ assetErrors.name }}</span>
                </label>
                <label>
                  {{ t("category") }}
                  <select v-model="assetForm.category" required>
                    <option v-for="option in categories" :key="option.value" :value="option.value">
                      {{ t(option.labelKey) }}
                    </option>
                  </select>
                </label>
                <label>
                  {{ t("quantity") }}
                  <input
                    v-model.number="assetForm.quantity"
                    type="number"
                    min="1"
                    step="1"
                    @input="clearAssetError('quantity')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.quantity">{{ assetErrors.quantity }}</span>
                </label>
                <label>
                  {{ t("totalCost", { currency: assetForm.currency }) }}
                  <input
                    v-model.number="assetForm.cost"
                    type="number"
                    min="0"
                    step="0.01"
                    @input="clearAssetError('cost')"
                    required
                  />
                  <span class="field-error" v-if="assetErrors.cost">{{ assetErrors.cost }}</span>
                </label>
                <label>
                  {{ t("assetCurrency") }}
                  <select v-model="assetForm.currency" required>
                    <option v-for="code in currencyOptions" :key="code" :value="code">
                      {{ code }}
                    </option>
                  </select>
                </label>
                <label>
                  {{ t("currentPrice") }}
                  <input
                    v-model.number="assetForm.currentPrice"
                    type="number"
                    min="0"
                    step="0.01"
                    :placeholder="t('currentPricePlaceholder')"
                  />
                </label>
                <label>
                  {{ t("riskLevel") }}
                  <select v-model="assetForm.riskLevel" required>
                    <option value="low">{{ t("riskLow") }}</option>
                    <option value="medium">{{ t("riskMedium") }}</option>
                    <option value="high">{{ t("riskHigh") }}</option>
                  </select>
                </label>
                <label>
                  {{ t("strategy") }}
                  <input
                    v-model="assetForm.strategy"
                    type="text"
                    :placeholder="t('strategyPlaceholder')"
                  />
                </label>
                <label>
                  {{ t("sentiment") }}
                  <input
                    v-model="assetForm.sentiment"
                    type="text"
                    :placeholder="t('sentimentPlaceholder')"
                  />
                </label>
                <label>
                  {{ t("assetTags") }}
                  <input
                    v-model="assetForm.tags"
                    type="text"
                    :placeholder="t('assetTagsPlaceholder')"
                  />
                </label>
                <label>
                  {{ t("assetNote") }}
                  <textarea
                    v-model="assetForm.note"
                    :placeholder="t('assetNotePlaceholder')"
                    rows="3"
                  ></textarea>
                </label>
                <div class="form-actions">
                  <button type="submit" class="primary-btn" :disabled="isLoading.save">
                    {{ isLoading.save ? t("saving") : editingLabel }}
                  </button>
                  <button
                    v-if="isEditing"
                    type="button"
                    class="secondary-btn"
                    @click="cancelEdit"
                    :disabled="isLoading.save"
                  >
                    {{ t("cancelEdit") }}
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="dashboard-grid">
            <div class="panel performance-panel">
              <div class="panel-header">
                <h2>{{ t("performanceTitle") }}</h2>
                <p>{{ t("performanceSubtitle") }}</p>
              </div>
              <div class="chart-wrapper">
                <canvas id="valueChart" height="220"></canvas>
              </div>
              <div class="stats stats-compact">
                <div>
                  <span>{{ t("marketValue") }}</span>
                  <strong>{{ performanceStats.marketValue }}</strong>
                </div>
                <div>
                  <span>{{ t("profitLoss") }}</span>
                  <strong :class="performanceStats.profitClass">{{ performanceStats.profit }}</strong>
                </div>
                <div>
                  <span>{{ t("returnRate") }}</span>
                  <strong :class="performanceStats.profitClass">{{ performanceStats.returnRate }}</strong>
                </div>
              </div>
              <p class="muted">{{ performanceStats.note }}</p>
            </div>

            <div class="panel budget-panel">
              <div class="panel-header">
                <h2>{{ t("budgetTitle") }}</h2>
                <p>{{ t("budgetSubtitle") }}</p>
              </div>
              <label>
                {{ t("budgetTarget", { currency: currencySymbol }) }}
                <input v-model.number="monthlyBudget" type="number" min="0" step="0.01" />
              </label>
              <div class="progress">
                <div class="progress-bar" :style="{ width: budgetProgress + '%' }"></div>
              </div>
              <div class="budget-stats">
                <span>{{ t("budgetUsed", { value: budgetUsedLabel }) }}</span>
                <span :class="{ warning: budgetProgress > 100 }">
                  {{ t("budgetProgress", { value: budgetProgressLabel }) }}
                </span>
              </div>
              <p class="muted" v-if="budgetProgress > 100">{{ t("budgetOver") }}</p>
            </div>

            <div class="panel currency-panel">
              <div class="panel-header">
                <h2>{{ t("currencyTitle") }}</h2>
                <p>{{ t("currencySubtitle") }}</p>
              </div>
              <label>
                {{ t("displayCurrency") }}
                <select v-model="displayCurrency">
                  <option v-for="code in currencyOptions" :key="code" :value="code">
                    {{ code }}
                  </option>
                </select>
              </label>
              <div class="rate-grid">
                <div class="rate-row" v-for="code in currencyOptions" :key="code">
                  <span>{{ code }}</span>
                  <input v-model.number="currencyRates[code]" type="number" min="0" step="0.0001" />
                  <span class="muted">{{ t("rateHint") }}</span>
                </div>
              </div>
            </div>

            <div class="panel import-panel">
              <div class="panel-header">
                <h2>{{ t("importTitle") }}</h2>
                <p>{{ t("importSubtitle") }}</p>
              </div>
              <div class="import-actions">
                <input ref="importFile" type="file" accept=".csv" @change="handleImportFile" />
                <button class="secondary-btn" type="button" @click="exportCsv">
                  {{ t("exportCsv") }}
                </button>
              </div>
              <p class="muted">{{ t("importHint") }}</p>
            </div>

            <div class="panel timeline-panel">
              <div class="panel-header">
                <h2>{{ t("timelineTitle") }}</h2>
                <p>{{ t("timelineSubtitle") }}</p>
              </div>
              <ul class="timeline-list" v-if="eventTimeline.length">
                <li v-for="event in eventTimeline" :key="event.id">
                  <span class="timeline-dot"></span>
                  <div>
                    <strong>{{ event.title }}</strong>
                    <p class="muted">{{ event.detail }}</p>
                    <span class="muted">{{ event.timeLabel }}</span>
                  </div>
                </li>
              </ul>
              <p class="muted" v-else>{{ t("timelineEmpty") }}</p>
            </div>

            <div class="panel risk-panel">
              <div class="panel-header">
                <h2>{{ t("riskTitle") }}</h2>
                <p>{{ t("riskSubtitle") }}</p>
              </div>
              <div class="risk-score">
                <strong>{{ riskScoreLabel }}</strong>
                <span class="muted">{{ t("riskScoreHint") }}</span>
              </div>
              <div class="risk-grid">
                <div class="risk-cell" v-for="item in riskBreakdown" :key="item.label">
                  <span>{{ item.label }}</span>
                  <strong>{{ item.percent }}%</strong>
                  <div class="risk-bar">
                    <div class="risk-fill" :style="{ width: item.percent + '%' }"></div>
                  </div>
                </div>
              </div>
              <div class="strategy-list">
                <h3>{{ t("strategyTitle") }}</h3>
                <div v-if="strategyBreakdown.length" class="strategy-chips">
                  <span class="badge badge-muted" v-for="item in strategyBreakdown" :key="item.label">
                    {{ item.label }} · {{ item.count }}
                  </span>
                </div>
                <p class="muted" v-else>{{ t("strategyEmpty") }}</p>
              </div>
            </div>
          </div>

          <div class="panel insights-panel">
            <div class="panel-header">
              <h2>{{ t("insightsTitle") }}</h2>
              <p>{{ t("insightsSubtitle") }}</p>
            </div>
            <div class="insights-grid">
              <div class="insight-card">
                <h3>{{ t("healthTitle") }}</h3>
                <ul class="health-list">
                  <li v-for="check in healthChecks" :key="check.label" :class="['health-item', check.status]">
                    <div>
                      <span class="health-label">{{ check.label }}</span>
                      <span class="health-value">{{ check.value }}</span>
                    </div>
                    <p class="health-detail">{{ check.detail }}</p>
                  </li>
                </ul>
              </div>
              <div class="insight-card">
                <h3>{{ t("targetTitle") }}</h3>
                <p class="muted">{{ t("targetSubtitle") }}</p>
                <div class="target-table">
                  <div class="target-row" v-for="row in allocationBreakdown" :key="row.key">
                    <div class="target-info">
                      <strong>{{ row.label }}</strong>
                      <span class="muted">{{ t("currentLabel") }} {{ row.percent }}%</span>
                    </div>
                    <div class="target-input">
                      <input v-model.number="allocationTargets[row.key]" type="number" min="0" max="100" />
                      <span class="muted">%</span>
                    </div>
                    <div class="target-delta" :class="row.deltaStatus">
                      {{ row.deltaLabel }}
                    </div>
                  </div>
                </div>
                <div class="target-footer" :class="{ warning: targetTotal !== 100 }">
                  {{ t("targetTotal", { total: targetTotal }) }}
                </div>
              </div>
              <div class="insight-card">
                <h3>{{ t("tagInsightTitle") }}</h3>
                <p class="muted">{{ t("tagInsightSubtitle") }}</p>
                <div class="tag-insight-list" v-if="tagSpotlight.length">
                  <div class="tag-insight-item" v-for="tag in tagSpotlight" :key="tag.label">
                    <div>
                      <strong class="tag-name">#{{ tag.label }}</strong>
                      <span class="muted">{{ tag.count }} {{ t("statAssets") }}</span>
                    </div>
                    <span class="tag-cost">{{ tag.totalCostLabel }}</span>
                  </div>
                </div>
                <p class="muted" v-else>{{ t("tagInsightEmpty") }}</p>
              </div>
              <div class="insight-card">
                <h3>{{ t("presetTitle") }}</h3>
                <div class="preset-controls">
                  <input v-model.trim="newPresetName" type="text" :placeholder="t('presetPlaceholder')" />
                  <button class="secondary-btn" type="button" @click="savePreset" :disabled="!canSavePreset">
                    {{ t("presetSave") }}
                  </button>
                </div>
                <div class="preset-list" v-if="presets.length">
                  <div class="preset-chip" v-for="preset in presets" :key="preset.id">
                    <button class="ghost-btn" type="button" @click="applyPreset(preset)">
                      {{ preset.name }}
                    </button>
                    <button class="icon-btn" type="button" @click="removePreset(preset.id)">
                      ✕
                    </button>
                  </div>
                </div>
                <p class="muted" v-else>{{ t("presetEmpty") }}</p>
                <h3 class="achievement-title">{{ t("achievementTitle") }}</h3>
                <div class="badge-list" v-if="achievementCards.length">
                  <div class="badge-card" v-for="badge in achievementCards" :key="badge.label">
                    <span class="badge-title">{{ badge.label }}</span>
                    <span class="muted">{{ badge.subtitle }}</span>
                    <div class="progress">
                      <div class="progress-bar" :style="{ width: badge.progress + '%' }"></div>
                    </div>
                  </div>
                </div>
                <span class="muted" v-else>{{ t("achievementEmpty") }}</span>
              </div>
            </div>
          </div>

          <div class="panel table-panel" aria-live="polite">
            <div class="panel-header">
              <h2>{{ t("tableTitle") }}</h2>
              <p>{{ t("tableSubtitle") }}</p>
            </div>
            <div class="table-actions">
              <div class="table-filters">
                <label class="filter-field">
                  <span class="filter-label">{{ t("searchPlaceholder") }}</span>
                  <input v-model.trim="filters.query" type="search" :placeholder="t('searchPlaceholder')" />
                </label>
                <label class="filter-field">
                  <span class="filter-label">{{ t("category") }}</span>
                  <select v-model="filters.category">
                    <option value="all">{{ t("filterAll") }}</option>
                    <option v-for="option in categories" :key="option.value" :value="option.value">
                      {{ t(option.labelKey) }}
                    </option>
                  </select>
                </label>
                <label class="filter-field">
                  <span class="filter-label">{{ t("filterTag") }}</span>
                  <input v-model.trim="filters.tag" type="search" :placeholder="t('filterTagPlaceholder')" />
                </label>
                <label class="filter-field">
                  <span class="filter-label">{{ t("filterSort") }}</span>
                  <select v-model="filters.sort">
                    <option value="recent">{{ t("sortRecent") }}</option>
                    <option value="name">{{ t("sortName") }}</option>
                    <option value="totalCost">{{ t("sortTotalCost") }}</option>
                    <option value="quantity">{{ t("sortQuantity") }}</option>
                  </select>
                </label>
              </div>
              <button class="ghost-btn" type="button" @click="clearFilters" :disabled="!hasActiveFilters">
                {{ t("clearFilters") }}
              </button>
            </div>
            <table class="table" v-if="visiblePortfolio.length" :aria-label="t('tableAriaHoldings')">
              <thead>
                <tr>
                  <th scope="col">{{ t("assetName") }}</th>
                  <th scope="col">{{ t("quantity") }}</th>
                  <th scope="col">{{ t("statTotalCost") }}</th>
                  <th scope="col">{{ t("marketValue") }}</th>
                  <th scope="col">{{ t("costPerShare") }}</th>
                  <th scope="col">{{ t("category") }}</th>
                  <th scope="col">{{ t("actions") }}</th>
                </tr>
              </thead>
              <tbody>
                <tr class="asset-row" v-for="asset in visiblePortfolio" :key="asset.id">
                  <td>
                    <div class="asset-name">{{ asset.name }}</div>
                    <div class="asset-tags">
                      <span class="badge">{{ t("category") }} {{ categoryLabel(asset.category) }}</span>
                      <span class="badge badge-muted">
                        {{ t("avgCostLabel", { value: currency(convertedCost(asset) / asset.quantity) }) }}
                      </span>
                      <span class="badge badge-tag" v-for="tag in asset.tags" :key="tag">
                        #{{ tag }}
                      </span>
                    </div>
                    <div class="asset-note" v-if="asset.note">{{ asset.note }}</div>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("quantity") }}</span>
                    <span class="cell-value">{{ asset.quantity }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("statTotalCost") }}</span>
                    <span class="cell-value">{{ currency(convertedCost(asset)) }}</span>
                    <span class="cell-meta">{{ asset.currency }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("marketValue") }}</span>
                    <span class="cell-value">{{ currency(convertedMarketValue(asset)) }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("costPerShare") }}</span>
                    <span class="cell-value">{{ currency(convertedCost(asset) / asset.quantity) }}</span>
                  </td>
                  <td>
                    <span class="cell-label">{{ t("category") }}</span>
                    <span class="cell-value">{{ categoryLabel(asset.category) }}</span>
                    <div class="cell-meta">
                      {{ t("riskLevel") }}: {{ riskLabel(asset.riskLevel) }}
                    </div>
                  </td>
                  <td>
                    <div class="table-actions-cell">
                      <button class="ghost-btn" type="button" @click="startEdit(asset)">
                        {{ t("edit") }}
                      </button>
                      <button
                        class="delete-btn"
                        @click="deleteAsset(asset.id)"
                        :disabled="isLoading.deletingId === asset.id"
                      >
                        {{ isLoading.deletingId === asset.id ? t("deleting") : t("delete") }}
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            <div class="empty-state" v-else role="status">
              {{ hasActiveFilters ? t("emptyStateFiltered") : t("emptyState") }}
            </div>
          </div>
        </section>
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js" defer></script>
    <script src="/static/app.js" defer></script>
  </body>
</html>
